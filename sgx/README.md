# Notes

This application runs in SGX **SIMULATION** mode, if you need to run it in hardware mode, please first ensure that the CPU on your device is newer than the 6th generation (Skylake), and that the SGX feature is fully enabled by the BIOS settings. Also, to run the application, you need to install Intel's SGX SDK and SGX drivers for the Linux OS.

## Some Guidances For Writing SGX Applications

* Enclave functions should be declared in `./include/enclave/*.hh`.
* Unstrusted functions should be declared in `./include/app/*.hh`.
* Wrapper functions such as `ecall_xxx()`, `ocall_xxx()` should also be defined in `./include/app/*.hh`.
* The trusted interfaces declared in `enclave.edl` should be implemented in file `./src/enclave/*.cc`, and the untrusted interfaces should be implemented in file `./src/app/*.cc`.
* The proxy functions are auto-generated by `sgx_edger8r`, do not modify them.
* You could always set the SGX environment arguments by adding one command to your shell's rc:

```shell
echo "source $SGX_SDK/environment" >> $HOME/.zshrc; # or $HOME/.bashrc
```

## Remote Attestation

* This version enables the Remote Attestation technology for Intel SGX.
* To serialize all the messages that are being transported via network, Google Protobuf is a must.
* Also, to start an encrypted session and make the application easier to use, we deployed the Google RPC (Remote Procedure Call).

## Google Remote Procedure Call

We strongly recommend that you install gRPC library from source since installing from package-manager will cause some problems. A bug-free installation will require CMake:

```shell
sudo apt install -y cmake
```

Then use git to clone the repository from github:

```shell
git clone --recurse-submodules -b v1.42.0 https://github.com/grpc/grpc $HOME/grpc
```

Configure it with cmake and install it on the computer:

```shell
cd $HOME/grpc
mkdir -p cmake/build
pushd cmake/build
cmake -DgRPC_INSTALL=ON \                
      -DgRPC_BUILD_TESTS=OFF \
      -DgRPC_SSL_PROVIDER=package \ # Do not link to libssl provided by the system.
      -DCMAKE_INSTALL_PREFIX=/usr/local \ # Change it to your own preferred directory, but better not install globally.
      -DBUILD_SHARED_LIBS=ON \
      ../..
make -j
sudo make install
popd
```

For more information, interested readers are referred to [this](https://grpc.io).

## Build our project

To build our project, you may need to first install Intel SGX SDK for Linux system, and you also need to install gRPC framework for the connection between the client and the server, and we strongly recommend that one should install gRPC via source rather than package manager. Finally, we will use the gFlag and spdlog library for command line argument parsing, and you can install it by

```shell
sudo apt install -y libgflags-dev libspdlog-dev
```

Also, you may also need to set the environment for the SGX SDK so that you can properly build the enclave:

```shell
source <SGX_PATH>/sgxsdk/environment
```

In addition, you should manually set the correct path for gRPC for loading the correct gRPC libraries in `client.mk` and `server.mk`.

* Build the server:

```shell
BUCKET_SIZE=128 make -j server # Note that the bucket size is defined in the macro.
```

* Build the client:

```shell
make -j client
```

* Build all:

```shell
make -j all
```

## Run the project

Extra care must be paid when one tries to properly run the server and the client. Before running, please make sure that the path of loaded libraries is correctly set, and the ssl key is generated:

```shell
source ./env.sh
sh -c ./keygen.sh
```

Otherwise, the system will throw an exception indicating the `libsample_libcrypto` and `libservice_provider` cannot be found.

If you upgraded gRPC, the old CPP source files auto-generated by the protobuf-compiler should be completely deleted to prevent bugs.

Finally, you could run the client and the server by

```shell
./build/bin/server.bin
./build/bin/client.bin
# If you want to specify the parameters, run ./build/bin/server.bin --help
```
